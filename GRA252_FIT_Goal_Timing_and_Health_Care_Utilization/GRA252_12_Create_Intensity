CREATE OR REPLACE TABLE INV_motion.GRA252_Intensity AS

SELECT
 enrolled_id
,steps_date
,COUNT(CASE WHEN CAST(FORMAT_DATETIME("%H", steps_dt) AS INT64) = 0 THEN 1 END) AS itnsty00
,COUNT(CASE WHEN CAST(FORMAT_DATETIME("%H", steps_dt) AS INT64) = 1 THEN 1 END) AS itnsty01
,COUNT(CASE WHEN CAST(FORMAT_DATETIME("%H", steps_dt) AS INT64) = 2 THEN 1 END) AS itnsty02
,COUNT(CASE WHEN CAST(FORMAT_DATETIME("%H", steps_dt) AS INT64) = 3 THEN 1 END) AS itnsty03
,COUNT(CASE WHEN CAST(FORMAT_DATETIME("%H", steps_dt) AS INT64) = 4 THEN 1 END) AS itnsty04
,COUNT(CASE WHEN CAST(FORMAT_DATETIME("%H", steps_dt) AS INT64) = 5 THEN 1 END) AS itnsty05
,COUNT(CASE WHEN CAST(FORMAT_DATETIME("%H", steps_dt) AS INT64) = 6 THEN 1 END) AS itnsty06
,COUNT(CASE WHEN CAST(FORMAT_DATETIME("%H", steps_dt) AS INT64) = 7 THEN 1 END) AS itnsty07
,COUNT(CASE WHEN CAST(FORMAT_DATETIME("%H", steps_dt) AS INT64) = 8 THEN 1 END) AS itnsty08
,COUNT(CASE WHEN CAST(FORMAT_DATETIME("%H", steps_dt) AS INT64) = 9 THEN 1 END) AS itnsty09
,COUNT(CASE WHEN CAST(FORMAT_DATETIME("%H", steps_dt) AS INT64) = 10 THEN 1 END) AS itnsty10
,COUNT(CASE WHEN CAST(FORMAT_DATETIME("%H", steps_dt) AS INT64) = 11 THEN 1 END) AS itnsty11
,COUNT(CASE WHEN CAST(FORMAT_DATETIME("%H", steps_dt) AS INT64) = 12 THEN 1 END) AS itnsty12
,COUNT(CASE WHEN CAST(FORMAT_DATETIME("%H", steps_dt) AS INT64) = 13 THEN 1 END) AS itnsty13
,COUNT(CASE WHEN CAST(FORMAT_DATETIME("%H", steps_dt) AS INT64) = 14 THEN 1 END) AS itnsty14
,COUNT(CASE WHEN CAST(FORMAT_DATETIME("%H", steps_dt) AS INT64) = 15 THEN 1 END) AS itnsty15
,COUNT(CASE WHEN CAST(FORMAT_DATETIME("%H", steps_dt) AS INT64) = 16 THEN 1 END) AS itnsty16
,COUNT(CASE WHEN CAST(FORMAT_DATETIME("%H", steps_dt) AS INT64) = 17 THEN 1 END) AS itnsty17
,COUNT(CASE WHEN CAST(FORMAT_DATETIME("%H", steps_dt) AS INT64) = 18 THEN 1 END) AS itnsty18
,COUNT(CASE WHEN CAST(FORMAT_DATETIME("%H", steps_dt) AS INT64) = 19 THEN 1 END) AS itnsty19
,COUNT(CASE WHEN CAST(FORMAT_DATETIME("%H", steps_dt) AS INT64) = 20 THEN 1 END) AS itnsty20
,COUNT(CASE WHEN CAST(FORMAT_DATETIME("%H", steps_dt) AS INT64) = 21 THEN 1 END) AS itnsty21
,COUNT(CASE WHEN CAST(FORMAT_DATETIME("%H", steps_dt) AS INT64) = 22 THEN 1 END) AS itnsty22
,COUNT(CASE WHEN CAST(FORMAT_DATETIME("%H", steps_dt) AS INT64) = 23 THEN 1 END) AS itnsty23
,MIN(CASE WHEN seq = rqd_itnsty_bouts THEN CAST(FORMAT_DATETIME("%H", steps_dt) AS INT64) END) AS intensity_met_hr
,CASE WHEN MAX(seq)>MIN(rqd_itnsty_bouts) THEN MAX(seq) - MIN(rqd_itnsty_bouts) END AS intensity_bouts_over

FROM INV_motion.GRA252_Intensity_List_Bouts 
GROUP BY enrolled_id, steps_date
